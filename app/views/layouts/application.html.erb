<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title><%= current_repository.name rescue 'Warehouse: ' %> <%= @title rescue '' %></title>
    <%= stylesheet_link_tag 'main' %>
    <%= stylesheet_link_tag 'code' %>
    <%= javascript_include_tag 'prototype', 'lowpro-lite', 'moo.fx.js', 'moo.fx.transitions.js', 'application', :cache => 'warehouse' %>
    <script src="http://warehouseapp.com/javascripts/version_check.js" type="text/javascript" charset="utf-8"></script>
    <%= yield :scripts %>
    <script type="text/javascript" charset="utf-8">
      Event.onReady(function() {
        <%= cache_current_sheets %>
        <% if logged_in? -%>
        Sheet.Cache['profile-form'] = new Sheet('profile-form', 'profile');
        <% else -%>
        Sheet.Cache['reset-form'] = new Sheet('reset-form', 'reset-from-openid');
        Sheet.Cache['openid-form'] = new Sheet('openid-form', ['openid-toggle'<%= %(, 'login-link', 'cancel-reset') unless use_login_form? %>]);
        Sheet.Cache['login-form'] = new Sheet('login-form', ['login-toggle'<%= %(, 'login-link', 'cancel-reset') if use_login_form? %>]);
        <% end -%>
        <%= yield :onready %>
      });
      <%= yield :javascript %>
    </script>
    <%= auto_discovery_link_tag(:atom, formatted_changesets_path(:atom)) %>
    <!--[if lt IE 8]>
      <%= stylesheet_link_tag 'curbstomp' %>
    <![endif]-->
  </head>
  <body>
    <%= @onready %>
    <!-- container -->
    <div id="container">
      <% if logged_in? %>
        <% sheet_form_for current_user, :url => profile_path(:to => request.request_uri), :html => { :multipart => true, :id => 'profile-form', :method => :put }, :trigger => false do |s| -%>
          <h2>Edit your profile</h2>
          <%= content_tag 'p', flash[:error] if flash[:error] %>
          <%= s.text_field 'SVN Login:', :login, :size => 30 %>
          <%= s.password_field 'SVN Password:', :password, :size => 30 %>
          <%= s.password_field 'Confirm:', :password_confirmation, :size => 30 %>
          <%= s.text_field 'Email:', :email, :size => 30 %>
          <p id="profile-pic"><%= avatar_for(current_user) %></p>
          <%= s.file_field "Profile picture:", :avatar_data, :size => 25 %>
          <% s.submit 'save.png' %>
        <% end -%>
      <% end %>
      <!-- header -->
      <div id="header">
        <div id="hdr-cnt">
          <h1><%= link_to current_repository ? current_repository.name : "Warehouse", root_path %></h1>
          <ul id="nav">
            <% unless repository_subdomain.blank? -%>
            <li id="code"><%= link_to 'Browser', browser_path %></li>
            <% end -%>
            <li id="activity"><%= link_to 'Activity', (!repository_subdomain.blank? || logged_in? ? changesets_path : public_changesets_path) %></li>
            <% if admin? || repository_admin? %>
            <li id="admin"><%= link_to 'Admin', admin_path %></li>
            <% end %>
          </ul>
          <ul id="utils">
            <% if logged_in? -%>
              <li id="profile"><%= link_to 'Profile', profile_path %></li>
              <li><%= link_to 'Logout', logout_path %></li>
            <% else -%>
              <li id="login-link"><%= link_to 'Login', '#' %></li>
            <% end -%>
          </ul>
          </div>
          <% unless logged_in? -%>
            <% sheet_form_tag login_path, :id => 'openid-form', :trigger => false do |s| -%>
              <h2>Login with OpenID (<%= link_to 'user/pass', '#', :id => 'login-toggle' %>)</h2>
              <%= content_tag 'p', flash[:error] if flash[:error] %>
              <%= s.text_field_tag %(OpenID: (<a href="#" id="reset-from-openid">reset</a>)), :openid_url, params[:openid_url], :class => 'big' %>
              <%  s.submit 'login.png' %>
            <% end -%>

            <% sheet_form_tag login_path, :id => 'login-form', :trigger => false do |s| -%>
              <h2>Login (<%= link_to 'OpenID', '#', :id => 'openid-toggle' %>)</h2>
              <%= content_tag 'p', flash[:error] if flash[:error] %>
              <%= s.text_field_tag     %(Login:),    :login,    params[:login], :class => 'big' %>
              <%= s.password_field_tag %(Password:), :password, params[:password], :class => 'big' %>
              <%  s.submit 'login.png' %>
            <% end -%>
            
            <% sheet_form_tag forget_path, :id => 'reset-form', :trigger => false do |s| %>
              <h2>Reset your OpenID</h2>
              <%= s.text_field_tag 'Email you signed up with: (<a href="#" id="cancel-reset">login</a>)', :email, '', :class => 'big' %>
            <% end %>
          <% end %>
        </div>
      <!-- /header -->
      <!-- content -->
      <div id="content" class="clearfix">
        <!-- main -->
        <div id="main"<% if @fullscreen -%> style="width:100%"<% end -%>>
          <%= yield %>
        </div>
        <!-- /main -->
        <% unless @fullscreen -%>
        <!-- sbar -->
        <div id="sbar">
          <%= yield :sidebar %>
          <% cache CacheKey.bookmarks_for(current_repository) do -%>
          <div id="bookmarks" class="sideblock"<%= %( style="display:none") if current_repository.bookmarks.to_a.empty? %>>
            <h3>Bookmarks</h3>
            <ul id="bookmark-list">
              <%= render :partial => "bookmarks/bookmark", :collection => current_repository.bookmarks %>
            </ul>
          </div>
          <% end if current_repository && (current_repository.public? || repository_member?) -%>
        </div>
        <!-- /sbar -->
        <% end -%>
      </div>
      <!-- /content -->
      <!-- footer -->
      <div id="footer">
        <a id="powered" href="http://warehouseapp.com" title="Warehouse v<%= Warehouse.version %>: web-based subversion browser"><img src="/images/app/warehouse-logo.png" title="Warehouse v<%= Warehouse.version %>: web-based Subversion Browser" alt="Warehouse logo" /></a>
      </div>
      <!-- /footer -->
      
    </div>
    <!-- /container -->
  </body>
</html>